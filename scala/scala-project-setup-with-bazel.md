# Give me steps to setup my Scala project to run with Bazel. My project has multiple microservices each in its own directory with its own BUILD file.

This setup guide uses **Bzlmod** (Bazel's modern module system), which is the standard for new projects.

### 1. Project Structure

Organize your project with a root directory containing your configuration and separate directories for your shared code and microservices.

```text
my-scala-project/
├── MODULE.bazel          # Root Bazel configuration
├── .bazelrc              # Bazel runtime flags
├── BUILD                 # (Optional) Root build file
├── shared-lib/           # Shared logic
│   ├── BUILD
│   └── src/main/scala/com/example/shared/Sharedutil.scala
├── service-a/            # Microservice A
│   ├── BUILD
│   └── src/main/scala/com/example/servicea/ServiceA.scala
└── service-b/            # Microservice B
    ├── BUILD
    └── src/main/scala/com/example/serviceb/ServiceB.scala
```

---

### 2. Configure `MODULE.bazel`

Create a `MODULE.bazel` file in your root directory. This replaces the legacy `WORKSPACE` file. We will pull in `rules_scala` for Scala support and `rules_jvm_external` to handle Maven dependencies (like Akka, Cats, etc.).

**`MODULE.bazel`**
```python
module(
    name = "my_scala_project",
    version = "0.1.0",
)

# 1. Setup Scala Rules
bazel_dep(name = "rules_scala", version = "7.1.1")

# 2. Setup Maven Dependencies (via rules_jvm_external)
bazel_dep(name = "rules_jvm_external", version = "6.1")

maven = use_extension("@rules_jvm_external//:extensions.bzl", "maven")

maven.install(
    artifacts = [
        "org.scalatest:scalatest_2.13:3.2.18",
        "com.typesafe.akka:akka-actor_2.13:2.6.20",
        # Add other external jars here
    ],
    repositories = [
        "https://repo1.maven.org/maven2",
    ],
    lock_file = "//:maven_install.json",
)

use_repo(maven, "maven")
```

**Note:** Run `bazel mod tidy` ensures your lockfile and module configurations remain consistent.

---

### 3. Create the Shared Library

Define a `scala_library` in `shared-lib/BUILD`. This library can be imported by your microservices.

**`shared-lib/BUILD`**
```python
load("@rules_scala//scala:scala.bzl", "scala_library")

scala_library(
    name = "shared-lib",
    srcs = glob(["src/main/scala/**/*.scala"]),
    visibility = ["//visibility:public"], # Make visible to other packages
    deps = [
        "@maven//:com_typesafe_akka_akka_actor_2_13", # Example external dep
    ],
)
```

---

### 4. Create Microservices

Define a `scala_binary` for each microservice. This creates an executable JAR. Notice how we depend on the `//shared-lib` target we just created.

**`service-a/BUILD`**
```python
load("@rules_scala//scala:scala.bzl", "scala_binary")

scala_binary(
    name = "service-a",
    srcs = glob(["src/main/scala/**/*.scala"]),
    main_class = "com.example.servicea.ServiceA",
    deps = [
        "//shared-lib:shared-lib",           # Internal dependency
        "@maven//:com_typesafe_akka_akka_actor_2_13", # External dependency
    ],
)
```

**`service-b/BUILD`**
```python
load("@rules_scala//scala:scala.bzl", "scala_binary")

scala_binary(
    name = "service-b",
    srcs = glob(["src/main/scala/**/*.scala"]),
    main_class = "com.example.serviceb.ServiceB",
    deps = [
        "//shared-lib:shared-lib",
    ],
)
```

---

### 5. Setup `.bazelrc` (Recommended)

Create a `.bazelrc` file in the root to ensure smooth execution and test output.

**`.bazelrc`**
```bash
# Enable Bzlmod explicitly (default in Bazel 7+, but good practice)
common --enable_bzlmod

# Print test output to console
test --test_output=errors
```

---

### 6. Run Your Project

Now you can build and run your services using the Bazel CLI.

1.  **Pin Maven Dependencies:**
    First, generate the dependency lock file (required by `rules_jvm_external`):
    ```bash
    bazel mod tidy
    ```

2.  **Build a specific service:**
    ```bash
    bazel build //service-a:service-a
    ```

3.  **Run a service:**
    ```bash
    bazel run //service-a:service-a
    ```

4.  **Test entire project:**
    If you add `scala_test` targets later, you can run all tests in the repo:
    ```bash
    bazel test //...
    ```

### Summary of Key Concepts
*   **`scala_library`**: Compiles code into a `.jar`. Use this for shared logic.
*   **`scala_binary`**: Compiles code and creates an executable script/jar. Use this for your microservice entry points.
*   **`//shared-lib:shared-lib`**: The label used to refer to your shared code from other BUILD files.
*   **`@maven//:artifact_id`**: The label format generated by `rules_jvm_external` for external JARs. Note that dots `.` and colons `:` in Maven coordinates are replaced by underscores `_`.
